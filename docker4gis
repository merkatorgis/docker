#!/bin/bash

here=$(dirname "$0")
if [ "$(basename "$here")" = '.bin' ]; then
    HOME=$(dirname "$0")/../$(basename "$0")
else
    HOME=$here
fi

action=$1
shift 1

if [ "$action" = 'base' ]; then
    echo "$HOME"/base
fi

if [ "$action" = 'component' ]; then
    component=$1
    tag=${2:-latest}
    template=$3
    image=docker4gis/$component:$tag
    # TODO: uncomment this to actually support "latest"
    # docker image pull "$image"
    container=$(docker container create "$image")
    docker container cp "$container":/template .
    docker container rm "$container"
    if ! [ "$template" ]; then
        default=./template/.default
        if [ -f "$default" ]; then
            template=$(cat "$default")
        fi
    fi
    cp -r ./template/"$template"/* .
    rm -rf ./template
fi

if [ "$action" = 'init' ]; then
    DOCKER_REGISTRY=$1
    DOCKER_USER=$2
    SHORT_NAME=$3

    [ "$DOCKER_REGISTRY" ] || read -rp "Enter the Docker registry (default is the Docker Hub; enter m for docker.merkator.com : " DOCKER_REGISTRY
    [ "$DOCKER_REGISTRY" = 'm' ] && DOCKER_REGISTRY=docker.merkator.com
    [ "$DOCKER_REGISTRY" = 'h' ] && DOCKER_REGISTRY=
    [ "$DOCKER_REGISTRY" ] && DOCKER_REGISTRY="$DOCKER_REGISTRY"/

    [ "$DOCKER_USER" ] || read -rp "Enter the application's name (the \"user\" in the Docker registry) : " DOCKER_USER
    [ "$DOCKER_USER" ] || exit 1

    [ "$SHORT_NAME" ] || read -rp "Optionally enter a short command name (default is the application's name) : " SHORT_NAME
    SHORT_NAME=${SHORT_NAME:-$DOCKER_USER}

    echo "DOCKER_REGISTRY=$DOCKER_REGISTRY
DOCKER_USER=$DOCKER_USER
DEBUG=false
PROXY_HOST=
PROXY_PORT=
PROXY_PORT_HTTP=
SECRET=
API=
AUTH_PATH=
APP=
HOMEDEST=
POSTGRES_LOG_STATEMENT=
# POSTGRES_LOG_STATEMENT=ddl
# POSTGRES_LOG_STATEMENT=all
POSTFIX_DESTINATION=
POSTFIX_DOMAIN=
MSYS_NO_PATHCONV=1" >.env

    cp "$HOME"/templates/main "$SHORT_NAME"
fi
